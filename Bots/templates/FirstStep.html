{% extends 'Base.html' %}
{% load static %}


{% block head %}
<style>
    #showcase8 {
        background: url("{% static 'pictures/some10.png' %}") center center/cover no-repeat;
        min-height: 350px;
        max-height: 350px;
        position: relative;
        display: block;
        margin: 0 auto;
    }
</style>
<meta name="description" content="First step, BotConstructor">
{% endblock head %}


{% block main_section %}
{% include 'Navbar.html' %}
<section id="showcase8" class="d-flex justify-content-center align-items-center shadow">
    <div id="header" class="container text-white">
        <h4 class="text-light">Here you must input your token</h4>
        <ul class="text-light">
            <li>Go to the Telegram and find <a href="https://t.me/BotFather" style="font-size: 20px;"
                    class="text-warning">@BotFather</a></li>
            <li>Follow the instructions there and generate the token</li>
            <li>Copy the token and enter it into the form</li>
        </ul>
        <h5 class="text-light mt-4">Warning. If the token is invalid, the form below will not be filled out
            automatically, and you will not proceed to the next step...</h5>
        <ul>
            <li class="text-light">If your token is real and the form will not be completed, just wait 3 minutes before
                creating it.
            </li>
        </ul>
    </div>
</section>

<div id="error"></div>

{% if messages %}
{% for message in messages %}
<div class="shadow p-5">
    <div class="container">
        <p style="font-size: 18px;" class="mb-0">{{ message }}</p>
    </div>
</div>
{% endfor %}
{% endif %}

<div class="shadow p-5">
    <div class="container">
        <form method="POST" onchange="getCredentialsOfBot(this); return false;"
            onmouseover="getCredentialsOfBot(this); return false;">
            {% csrf_token %}

            <label for="id_access_token" class="mb-0">{{ first_form.access_token.label }}</label>
            <div id="input_access">
                {{ first_form.access_token }}
            </div>


            <div class="form-row">
                <div class="col-md-6">
                    <label for="id_title" class="mb-0 mt-2">{{ first_form.title.label }}</label>
                    {{ first_form.title }}
                </div>

                <div class="col-md-6">
                    <label for="id_username" class="mb-0 mt-2">{{ first_form.username.label }}</label>
                    {{ first_form.username }}
                </div>
            </div>

            <button type="submit"
                class="btn btn-outline-light text-dark border-left border-bottom border-right shadow-sm mt-4"
                style="width: 20%;" id="id_button_nxt">
                Next
            </button>
        </form>
    </div>
</div>
{% endblock main_section %}

{% block javascript %}
<script type="text/javascript" async>
    var countHover = 0;
    var params = {};
    var currentToken = '';

    function getCredentialsOfBot(form) {
        var token = $(form).find('#id_access_token').val();

        if (token !== currentToken) {
            currentToken = token;
            params = {};
            countHover = 0;
        }

        if (token !== '') {
            if (countHover === 0) {
                document.getElementById('input_access').innerHTML = `<div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <div class="spinner-border text-dark" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </span>
                    </div>
                    <input type="text" name="access_token" class="form-control shadow-sm" placeholder="Access Token" required="" id="id_access_token" value="` + token + `">
                </div>`;
                countHover += 1;
            }

            if (Object.keys(params).length === 0) {
                $.ajax({
                    type: 'POST',
                    url: '{% url "until_first_step" %}',
                    data: {
                        token: token,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function (json) {
                        if ('title' in json && "username" in json) {
                            document.getElementById('id_title').value = json.title;
                            document.getElementById('id_username').value = json.username;
                            if (!(json.button)) {
                                document.getElementById('id_button_nxt').setAttribute('disabled', 'disabled');
                            }
                            else {
                                document.getElementById('id_button_nxt').removeAttribute('disabled');
                                document.getElementById('input_access').innerHTML = `<input type="text" name="access_token" class="form-control shadow-sm" placeholder="Access Token" required="" id="id_access_token" value="` + token + `">`;
                                params = json;
                                currentToken = token;
                            }
                        }
                        else {
                            document.getElementById('id_button_nxt').setAttribute('disabled', 'disabled');
                        }
                    },
                    error: function (xhr, errmsg, err) {

                    }
                });
            }
        }
    }
</script>
{% endblock javascript %}