{% extends 'Base.html' %}
{% load static %}


{% block head %}
<style>
    #showcase8 {
        background: url("{% static 'pictures/some10.png' %}") center center/cover no-repeat;
        min-height: 350px;
        max-height: 350px;
        position: relative;
        display: block;
        margin: 0 auto;
    }
</style>
<meta name="description" content="First step, BotConstructor">
{% endblock head %}


{% block main_section %}
{% include 'Navbar.html' %}
<section id="showcase8" class="d-flex justify-content-center align-items-center shadow">
    <div id="header" class="container text-white">
        <h4 class="text-light">Here you can see your profile</h4>
        <ul class="text-light">
            <li>Go to the Telegram and find @BotFather</li>
            <li>There follow the instructions and generate the token</li>
            <li>Copy API token and input this in form</li>
        </ul>
    </div>
</section>

<div id="error"></div>

<div class="container">
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-light text-dark border-bottom border-left border-right shadow-sm mt-4">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
</div>

<div class="shadow p-5">
    <div class="container">
        <form method="POST" onchange="getCredentialsOfBot(this); return false;">
            {% csrf_token %}

            <label for="id_access_token" class="mb-0">{{ first_form.access_token.label }}</label>
            {{ first_form.access_token }}

            <div class="form-row">
                <div class="col-md-6">
                    <label for="id_title" class="mb-0 mt-2">{{ first_form.title.label }}</label>
                    {{ first_form.title }}
                </div>

                <div class="col-md-6">
                    <label for="id_username" class="mb-0 mt-2">{{ first_form.username.label }}</label>
                    {{ first_form.username }}
                </div>
            </div>

            <button type="submit"
                class="btn btn-outline-light text-dark border-left border-bottom border-right shadow-sm btn-sm mt-4"
                style="width: 20%;" id="id_button_nxt">Next</button>
        </form>
    </div>
</div>
{% endblock main_section %}


{% block javascript %}
<script type="text/javascript" defer>
    function getCredentialsOfBot(form) {
        var token = $(form).find('#id_access_token').val();

        $.ajax({
            type: 'POST',
            url: '{% url "until_first_step" %}',
            data: {
                token: token,
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function (json) {
                if ('title' in json && "username" in json) {
                    document.getElementById('id_title').value = json.title;
                    document.getElementById('id_username').value = json.username;
                    if (!(json.button)) {
                        document.getElementById('id_button_nxt').setAttribute('disabled', 'disabled');
                    }
                    else {
                        document.getElementById('id_button_nxt').removeAttribute('disabled');
                    }
                }
                else {
                    document.getElementById('id_button_nxt').setAttribute('disabled', 'disabled');
                }
            },
            error: function (xhr, errmsg, err) {

            }
        });
    }
</script>
{% endblock javascript %}